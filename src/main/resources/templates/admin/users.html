<!-- admin/users.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:fragment="page(name, alerts, formatter)"
      th:data-theme="${user.theme.name.toLowerCase}">

<head th:replace="~{components :: head('Admin Users')}"></head>
<body>
<div th:replace="~{components :: admin-navbar(${name})}"></div>
<div class="bg-base-100 flex flex-col items-center min-h-screen m-10 gap-5">
    <div th:replace="~{components :: alerts(${alerts})}"></div>
    <div class="card card-normal w-full bg-base-200">
        <div class="card-body gap-10">
            <div class="flex justify-between items-center">
                <h1 class="card-title">All Users</h1>
            </div>

            <!-- Filter Form -->
            <div th:replace="~{this :: filterForm('/admin/users/table')}"></div>

            <div class="overflow-x-auto">
                <div th:replace="~{this :: userTable(sort)}"></div>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{components :: footer}"></div>

<!-- Dialog Container - Add this div to hold the dynamically loaded dialog -->
<div id="dialogContainer"></div>

<!-- Confirmation Dialog -->
<dialog th:fragment="confirmationDialog" id="adminConfirmDialog" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Confirm Admin Privilege Removal</h3>
        <p class="py-4">
            This user is currently a faculty lead for the following programs:
        </p>
        <ul class="list-disc list-inside mb-4">
            <li th:each="program : ${programs}" th:text="${program.title()}"></li>
        </ul>
        <p>
            For programs where they are the only faculty lead, the lead role will be transferred to the admin account.
        </p>
        <div class="modal-action">
            <form th:action="@{/admin/users/{username}/admin-status(username=${username},confirmed=true)}"
                  method="POST"
                  class="inline">
                <input type="hidden" name="grantAdmin" value="false"/>
                <button type="submit" class="btn btn-warning">Proceed</button>
            </form>
            <button class="btn" onclick="document.getElementById('adminConfirmDialog').close()">Cancel</button>
        </div>
    </div>
</dialog>

<!-- User Table Fragment -->
<table class="table w-full" th:fragment="userTable(sort)" id="userTable">
    <thead>
    <tr>
        <th th:replace="~{this :: sortableHeader('Name', '/admin/users/table', 'NAME')}"></th>
        <th th:replace="~{this :: sortableHeader('Email', '/admin/users/table', 'EMAIL')}"></th>
        <th th:replace="~{this :: sortableHeader('Role', '/admin/users/table', 'ROLE')}"></th>
        <th th:replace="~{this :: sortableHeader('Type', '/admin/users/table', 'USER_TYPE')}"></th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="userInfo : ${users}"
        th:class="${userInfo.user.isAdmin() ? 'bg-primary bg-opacity-10 border-base-300 border-y-2' : 'border-base-300 border-y-2'}"
        th:data-user-type="${userInfo.userType}">
        <td th:text="${userInfo.user.displayName()}"></td>
        <td th:text="${userInfo.user.email()}"></td>
        <td th:text="${userInfo.user.role()}"></td>
        <td>
            <span th:text="${userInfo.userType}"
                  th:class="${userInfo.userType == 'SSO' ? 'badge badge-info' : 'badge badge-accent'}">
            </span>
        </td>
        <td>
            <!-- Don't show any buttons for the admin user -->
            <div th:if="${userInfo.user.username != 'admin'}" class="flex gap-2">
                <!-- For non-admin users, show Grant Admin button -->
                <form th:if="${!userInfo.user.isAdmin()}"
                      th:action="@{/admin/users/{username}/admin-status(username=${userInfo.user.username})}"
                      method="POST"
                      class="inline">
                    <input type="hidden" name="grantAdmin" value="true"/>
                    <button type="submit" class="btn btn-sm btn-primary">
                        Grant Admin
                    </button>
                </form>
                <!-- For admin users (except super admin), show Revoke Admin button with HTMX -->
                <form th:if="${userInfo.user.isAdmin() && userInfo.user.username != 'admin'}"
                      th:action="@{/admin/users/{username}/admin-status(username=${userInfo.user.username})}"
                      th:hx-post="@{/admin/users/{username}/admin-status(username=${userInfo.user.username})}"
                      hx-target="#dialogContainer"
                      hx-swap="innerHTML"
                      method="POST"
                      class="inline">
                    <input type="hidden" name="grantAdmin" value="false"/>
                    <button type="submit" class="btn btn-sm btn-warning">
                        Revoke Admin
                    </button>
                </form>
            </div>
        </td>
    </tr>
    </tbody>
    <div hx-swap-oob="true" id="filterSortParams">
        <input type="hidden" name="sort" th:value="${sort}" />
        <input type="hidden" name="ascending" th:value="${ascending}" />
    </div>
</table>

<!-- Filter Form Fragment -->
<form xmlns:th="http://www.thymeleaf.org"
      th:fragment="filterForm(path)"
      id="filterForm">
    <div id="filterSortParams">
        <input type="hidden" name="sort" th:value="${sort}" />
        <input type="hidden" name="ascending" th:value="${ascending}" />
    </div>

    <div class="flex gap-4">
        <label>
            <input type="text"
                   name="searchFilter"
                   placeholder="Search users..."
                   class="input"
                   th:value="${searchFilter}"
                   th:hx-get="@{${path}}"
                   hx-trigger="input delay:300ms"
                   hx-include="#filterForm"
                   autocomplete="off"
                   hx-target="#userTable"
                   hx-swap="outerHTML" />
        </label>
    </div>
</form>

<!-- Sortable Header Fragment -->
<div xmlns:th="http://www.thymeleaf.org" th:fragment="sortableHeader(label, path, column)">
    <th th:class="${sort == column ? 'bg-base-300 cursor-pointer' : 'bg-base-200 cursor-pointer'}"
        th:hx-get="@{${path}(sort=${column}, ascending=${!ascending}, searchFilter=${searchFilter})}"
        hx-target="#userTable"
        hx-swap="outerHTML">
        <div class="flex items-center gap-2">
            <span th:if="${sort == column}" th:text="${ascending} ? '▲' : '▼'"></span>
            <div th:unless="${sort == column}" class="invisible">▼</div>
            <span th:text="${label}"></span>
        </div>
    </th>
</div>

<!-- Add dialog handling script -->
<script>
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === 'dialogContainer') {
            const dialog = document.getElementById('adminConfirmDialog');
            if (dialog) {
                dialog.showModal();
            }
        }
    });
</script>

</body>
</html>