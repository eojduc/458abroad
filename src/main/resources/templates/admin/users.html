<!-- admin/users.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:fragment="page(name, alerts, formatter)"
      th:data-theme="${user.theme.name.toLowerCase}">

<head th:replace="~{components :: head('Admin Users')}"></head>
<body>
<div th:replace="~{components :: admin-navbar(${name})}"></div>
<div class="bg-base-100 flex flex-col items-center min-h-screen m-10 gap-5">
    <div th:replace="~{components :: alerts(${alerts})}"></div>
    <div class="card card-normal w-full bg-base-200">
        <div class="card-body gap-10">
            <div class="flex justify-between items-center">
                <h1 class="card-title">All Users</h1>
            </div>

            <!-- Filter Form -->
            <form id="filterForm" th:fragment="filterForm">
                <div id="filterSortParams">
                    <input type="hidden" name="sort" th:value="${sort}" />
                    <input type="hidden" name="ascending" th:value="${ascending}" />
                </div>

                <div class="flex gap-4">
                    <label>
                        <input type="text"
                               name="searchFilter"
                               placeholder="Search users..."
                               class="input"
                               th:value="${searchFilter}"
                               th:hx-get="@{/admin/users/table}"
                               hx-trigger="input delay:300ms"
                               hx-include="#filterForm"
                               autocomplete="off"
                               hx-target="#userTableContainer"
                               hx-swap="innerHTML" />
                    </label>
                </div>
            </form>

            <!-- User Table Container -->
            <div id="userTableContainer">
                <!-- User Table Fragment -->
                <div th:fragment="userTable" id="userTable" class="contents">
                    <div class="overflow-x-auto">
                        <table class="table w-full">
                            <thead>
                            <tr>
                                <th th:replace="~{this :: sortableHeader('Name', '/admin/users/table', 'NAME', '#userTableContainer')}"></th>
                                <th th:replace="~{this :: sortableHeader('Email', '/admin/users/table', 'EMAIL', '#userTableContainer')}"></th>
                                <th th:replace="~{this :: sortableHeader('Role', '/admin/users/table', 'ROLE', '#userTableContainer')}"></th>
                                <th th:replace="~{this :: sortableHeader('Type', '/admin/users/table', 'USER_TYPE', '#userTableContainer')}"></th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="userInfo : ${users}"
                                th:class="${userInfo.user.isAdmin() ? 'bg-primary bg-opacity-10 border-base-300 border-y-2' : 'border-base-300 border-y-2'}"
                                th:data-user-type="${userInfo.userType}">
                                <td th:text="${userInfo.user.displayName()}"></td>
                                <td th:text="${userInfo.user.email()}"></td>
                                <td th:text="${userInfo.user.role()}"></td>
                                <td>
                                    <span th:text="${userInfo.userType}"
                                          th:class="${userInfo.userType == 'SSO' ? 'badge badge-info' : 'badge badge-accent'}">
                                    </span>
                                </td>
                                <td>
                                    <!-- Don't show any buttons for the admin user -->
                                    <div th:if="${userInfo.user.username != 'admin'}" class="flex gap-2">
                                        <!-- For non-admin users, show Grant Admin button -->
                                        <form th:if="${!userInfo.user.isAdmin()}"
                                              th:action="@{/admin/users/{username}/admin-status(username=${userInfo.user.username})}"
                                              method="POST"
                                              class="inline">
                                            <input type="hidden" name="grantAdmin" value="true"/>
                                            <button type="submit" class="btn btn-sm btn-primary">
                                                Grant Admin
                                            </button>
                                        </form>
                                        <!-- For admin users (except super admin), show Revoke Admin button with HTMX -->
                                        <form th:if="${userInfo.user.isAdmin() && userInfo.user.username != 'admin'}"
                                              th:action="@{/admin/users/{username}/admin-status(username=${userInfo.user.username})}"
                                              th:hx-post="@{/admin/users/{username}/admin-status(username=${userInfo.user.username})}"
                                              hx-target="#adminDialogContainer"
                                              hx-swap="innerHTML"
                                              method="POST"
                                              class="inline">
                                            <input type="hidden" name="grantAdmin" value="false"/>
                                            <button type="submit" class="btn btn-sm btn-warning">
                                                Revoke Admin
                                            </button>
                                        </form>

                                        <!-- Reset Password Button (only for LOCAL users) -->
                                        <button th:if="${userInfo.userType == 'LOCAL' && userInfo.user.username != 'admin'}"
                                                class="btn btn-sm btn-secondary"
                                                th:hx-get="@{/admin/users/{username}/show-reset-password(username=${userInfo.user.username})}"
                                                hx-target="#passwordDialogContainer"
                                                hx-swap="innerHTML">
                                            Reset Password
                                        </button>

                                        <!-- Delete User Button (only for LOCAL users, not for current user) -->
                                        <button th:if="${userInfo.userType == 'LOCAL' && userInfo.user.username != 'admin' && userInfo.user.username != user.username()}"
                                                class="btn btn-sm btn-error"
                                                th:hx-get="@{/admin/users/{username}/show-delete-user(username=${userInfo.user.username})}"
                                                hx-target="#deleteUserDialogContainer"
                                                hx-swap="innerHTML">
                                            Delete User
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div hx-swap-oob="true" id="filterSortParams">
                        <input type="hidden" name="sort" th:value="${sort}" />
                        <input type="hidden" name="ascending" th:value="${ascending}" />
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{components :: footer}"></div>

<!-- Completely separate dialog containers -->
<div id="adminDialogContainer"></div>
<div id="passwordDialogContainer"></div>
<div id="deleteUserDialogContainer"></div>

<!-- Confirmation Dialog Fragment -->
<dialog th:fragment="confirmationDialog" id="adminConfirmDialog" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Confirm Admin Privilege Removal</h3>
        <p class="py-4">
            This user is currently a faculty lead for the following programs:
        </p>
        <ul class="list-disc list-inside mb-4">
            <li th:each="program : ${programs}" th:text="${program.title()}"></li>
        </ul>
        <p>
            For programs where they are the only faculty lead, the lead role will be transferred to the admin account.
        </p>
        <div class="modal-action">
            <form th:action="@{/admin/users/{username}/admin-status(username=${username},confirmed=true)}"
                  method="POST"
                  class="inline">
                <input type="hidden" name="grantAdmin" value="false"/>
                <button type="submit" class="btn btn-warning">Proceed</button>
            </form>
            <button class="btn" onclick="closeAdminDialog()">Cancel</button>
        </div>
    </div>
</dialog>

<!-- Password Reset Dialog Fragment -->
<dialog th:fragment="passwordResetDialog" id="passwordResetDialog" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Reset User Password</h3>
        <p class="py-4">
            Enter a new password for this user. The password must be at least 8 characters.
        </p>
        <form th:action="@{/admin/users/{username}/reset-password(username=${username})}"
              method="POST"
              class="flex flex-col gap-4">
            <div class="form-control">
                <label class="label">
                    <span class="label-text">New Password</span>
                </label>
                <input type="password"
                       name="newPassword"
                       class="input input-bordered"
                       placeholder="Enter new password"
                       required
                       minlength="8"/>
            </div>
            <div class="form-control">
                <label class="label">
                    <span class="label-text">Confirm New Password</span>
                </label>
                <input type="password"
                       name="confirmPassword"
                       class="input input-bordered"
                       placeholder="Confirm new password"
                       required
                       minlength="8"/>
            </div>
            <div class="modal-action">
                <button type="submit" class="btn btn-primary">Reset Password</button>
                <button type="button" class="btn" onclick="closePasswordDialog()">Cancel</button>
            </div>
        </form>
    </div>
</dialog>

<!-- Delete User Dialog Fragment -->
<dialog th:fragment="deleteUserDialog" id="deleteUserDialog" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg text-error">Confirm User Deletion</h3>
        <div class="py-4">
            <p class="mb-2 font-semibold">WARNING: This action cannot be undone!</p>
            <p>You are about to permanently delete this user account.</p>

            <!-- Show faculty lead programs if any -->
            <div th:if="${facultyLeadPrograms != null and !facultyLeadPrograms.isEmpty()}" class="mt-4">
                <p class="font-semibold">This user is currently a faculty lead for the following programs:</p>
                <ul class="list-disc list-inside mb-2 mt-1">
                    <li th:each="program : ${facultyLeadPrograms}" th:text="${program.title()}"></li>
                </ul>
                <p class="text-sm">If they are the only faculty lead for any program, the admin account will be assigned as the faculty lead.</p>
            </div>

            <!-- Show applications if any - FIXED: Changed "application" to "userApp" -->
            <div th:if="${applications != null and !applications.isEmpty()}" class="mt-4">
                <p class="font-semibold">This user has submitted the following applications:</p>
                <ul class="list-disc list-inside mb-2 mt-1">
                    <li th:each="userApp : ${applications}"
                        th:text="'Application ID: ' + ${userApp.id()} + ' (Program ID: ' + ${userApp.programId()} + ')'"></li>
                </ul>
                <p class="text-sm">These applications will remain in the system but will be associated with a deleted user.</p>
            </div>

            <p class="mt-4">Any notes authored by this user will be preserved but marked as authored by "DELETED USER".</p>
        </div>
        <div class="modal-action">
            <form th:action="@{/admin/users/{username}/delete-user(username=${username})}"
                  method="POST">
                <button type="submit" class="btn btn-error">Delete User</button>
            </form>
            <button class="btn" onclick="closeDeleteUserDialog()">Cancel</button>
        </div>
    </div>
</dialog>

<!-- Sortable Header Fragment -->
<div th:fragment="sortableHeader(label, path, column, target)" th:remove="tag">
    <th th:class="${sort == column ? 'bg-base-300 cursor-pointer' : 'bg-base-200 cursor-pointer'}"
        th:hx-get="@{${path}(sort=${column}, ascending=${!ascending}, searchFilter=${searchFilter})}"
        th:hx-target="${target}"
        hx-swap="innerHTML">
        <div class="flex items-center gap-2">
            <span th:if="${sort == column}" th:text="${ascending} ? '▲' : '▼'"></span>
            <div th:unless="${sort == column}" class="invisible">▼</div>
            <span th:text="${label}"></span>
        </div>
    </th>
</div>

<!-- Admin functionality script -->
<script>
    document.body.addEventListener('htmx:beforeSwap', function(evt) {
        // Only handle admin-related redirects
        if (evt.detail.target && evt.detail.target.id === 'adminDialogContainer' &&
            evt.detail.xhr.responseURL.includes('success=User%20admin%20status%20updated%20successfully')) {
            // Cancel the HTMX swap
            evt.detail.shouldSwap = false;
            // Redirect to the success page
            window.location.href = evt.detail.xhr.responseURL;
        }
    });

    document.body.addEventListener('htmx:afterSwap', function(evt) {
        // Only handle admin dialog
        if (evt.detail.target && evt.detail.target.id === 'adminDialogContainer') {
            const adminConfirmDialog = document.getElementById('adminConfirmDialog');
            if (adminConfirmDialog) {
                adminConfirmDialog.showModal();
            }
        }
    });

    function closeAdminDialog() {
        const dialog = document.getElementById('adminConfirmDialog');
        if (dialog) {
            dialog.close();
        }
        document.getElementById('adminDialogContainer').innerHTML = '';
    }
</script>

<!-- Password reset script -->
<script>
    document.body.addEventListener('htmx:beforeSwap', function(evt) {
        // Only handle password-related redirects
        if (evt.detail.target && evt.detail.target.id === 'passwordDialogContainer' &&
            evt.detail.xhr.responseURL.includes('success=Password%20reset%20successfully')) {
            // Cancel the HTMX swap
            evt.detail.shouldSwap = false;
            // Redirect to the success page
            window.location.href = evt.detail.xhr.responseURL;
        }
    });

    document.body.addEventListener('htmx:afterSwap', function(evt) {
        // Only handle password dialog
        if (evt.detail.target && evt.detail.target.id === 'passwordDialogContainer') {
            const passwordResetDialog = document.getElementById('passwordResetDialog');
            if (passwordResetDialog) {
                passwordResetDialog.showModal();
            }
        }
    });

    function closePasswordDialog() {
        const dialog = document.getElementById('passwordResetDialog');
        if (dialog) {
            dialog.close();
        }
        document.getElementById('passwordDialogContainer').innerHTML = '';
    }
</script>

<!-- Delete user script -->
<script>
    document.body.addEventListener('htmx:beforeSwap', function(evt) {
        // Only handle delete user-related redirects
        if (evt.detail.target && evt.detail.target.id === 'deleteUserDialogContainer' &&
            evt.detail.xhr.responseURL && evt.detail.xhr.responseURL.includes('success=User%20deleted%20successfully')) {
            // Cancel the HTMX swap
            evt.detail.shouldSwap = false;
            // Redirect to the success page
            window.location.href = evt.detail.xhr.responseURL;
        }
    });

    document.body.addEventListener('htmx:afterSwap', function(evt) {
        // Only handle delete user dialog
        if (evt.detail.target && evt.detail.target.id === 'deleteUserDialogContainer') {
            const deleteUserDialog = document.getElementById('deleteUserDialog');
            if (deleteUserDialog) {
                deleteUserDialog.showModal();
            }
        }
    });

    function closeDeleteUserDialog() {
        const dialog = document.getElementById('deleteUserDialog');
        if (dialog) {
            dialog.close();
        }
        document.getElementById('deleteUserDialogContainer').innerHTML = '';
    }

    // Debug HTMX requests
    document.addEventListener('htmx:beforeRequest', function(evt) {
        console.log('HTMX Request:', evt.detail);
    });

    document.addEventListener('htmx:responseError', function(evt) {
        console.error('HTMX Response Error:', evt.detail);
    });
</script>

</body>
</html>