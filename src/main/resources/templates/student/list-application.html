<!DOCTYPE html>
<html
        xmlns:th="http://www.thymeleaf.org"
        th:fragment="page"
        th:data-theme="${user.theme.name.toLowerCase}"
>
<head th:replace="~{components :: head('My Applications')}"></head>
<body class="min-h-screen flex flex-col">
<div
        th:replace="~{components :: student-navbar(${user.displayName()})}"
></div>
<div class="bg-base-100 flex flex-col items-center min-h-screen m-10 gap-4">
  <div class="card card-normal w-full bg-base-200">
    <div class="card-body gap-10">
      <h1 class="card-title">My Applications</h1>
      <div th:fragment="programTable" id="programTable" class="contents">
        <!-- Show success message if present -->
        <div th:if="${message}" class="alert alert-success shadow-lg py-2 px-4">
          <div class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 stroke-current" fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span th:text="${message}"></span>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="table table-lg w-full">
            <thead>
            <tr>
              <th th:replace="~{this :: sortableHeader('Title', '/applications/sort', 'TITLE', '#programTable')}"></th>
              <th th:replace="~{this :: sortableHeader('Year & Semester', '/applications/sort', 'YEAR_SEMESTER', '#programTable')}"></th>
              <th th:replace="~{this :: sortableHeader('Faculty Lead(s)', '/applications/sort', 'FACULTY', '#programTable')}"></th>
              <th th:replace="~{this :: sortableHeader('Start Date', '/applications/sort', 'START_DATE', '#programTable')}"></th>
              <th th:replace="~{this :: sortableHeader('End Date', '/applications/sort', 'END_DATE', '#programTable')}"></th>
              <th th:replace="~{this :: sortableHeader('Application Open', '/applications/sort', 'APPLICATION_OPEN', '#programTable')}"></th>
              <th th:replace="~{this :: sortableHeader('Application Closed', '/applications/sort', 'APPLICATION_CLOSED', '#programTable')}"></th>
              <th th:replace="~{this :: sortableHeader('Status', '/applications/sort', 'STATUS', '#programTable')}"></th>
              <th>Essential Documents</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="pair : ${pairs}" class="border-base-300 border-y-2">
              <td>
                <a th:href="@{'/applications/' + ${pair.app().id()}}"
                   class="link link-primary">
                  <span th:text="${pair.prog().title()}">Program Title</span>
                </a>
              </td>
              <td th:text="${formatter.formatTerm(pair.prog().semester(), pair.prog().year())}"></td>
              <td>TODO</td>
              <td th:text="${formatter.formatLocalDate(pair.prog().startDate())}"></td>
              <td th:text="${formatter.formatLocalDate(pair.prog().endDate())}"></td>
              <td th:text="${formatter.formatLocalDate(pair.prog().applicationOpen())}"></td>
              <td th:text="${formatter.formatLocalDate(pair.prog().applicationClose())}"></td>
              <td>
                <div th:replace="~{components :: statusBadge(${pair.app().status().name()})}"></div>
              </td>
              <!-- Essential Documents Column -->
              <td>
                <!-- Show documents for APPROVED or ENROLLED applications -->
                <div th:if="${pair.app().status() == T(com.example.abroad.model.Application.Status).APPROVED ||
                                                      pair.app().status() == T(com.example.abroad.model.Application.Status).ENROLLED}"
                     class="space-y-2">

                  <!-- Warning alert for missing documents -->
                  <div th:if="${pair.missingDocumentsCount > 0}"
                       class="alert alert-warning shadow-lg py-2 px-4">
                    <div class="flex items-center gap-2">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                           class="stroke-warning w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                      </svg>
                      <span class="text-sm">
                                                [[${pair.missingDocumentsCount}]] document(s) required
                                            </span>
                    </div>
                  </div>

                  <!-- Document list -->
                  <div th:each="doc : ${pair.documents}" class="space-y-1">
                    <div class="flex items-center gap-2">
                      <!-- Status icon -->
                      <span th:if="${doc.submitted}" class="text-success">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                                     class="w-4 h-4 stroke-current">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                          d="M5 13l4 4L19 7"/>
                                                </svg>
                                            </span>
                      <span th:unless="${doc.submitted}" class="text-error">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                                     class="w-4 h-4 stroke-current">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                          d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                </svg>
                                            </span>

                      <!-- Document name -->
                      <span th:text="${doc.type.text()}" class="text-sm">Document Type</span>

                      <!-- View button and timestamp for submitted documents -->
                      <div th:if="${doc.submitted}" class="flex items-center gap-2">
                        <a th:href="@{/applications/{appId}/documents/{type}/view(appId=${doc.applicationId},type=${doc.type})}"
                           class="btn btn-xs btn-ghost"
                           target="_blank">
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                               class="w-4 h-4 stroke-current">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                          </svg>
                          <span class="ml-1">View</span>
                        </a>

                        <!-- Display timestamp -->
                        <span th:if="${doc.formattedTimestamp}" class="text-xs text-base-content/70">
                                                    Last updated: [[${doc.formattedTimestamp}]]
                                                </span>
                      </div>
                    </div>

                    <!-- Upload/re-upload form section -->
                    <div th:if="${doc.submitted}" class="pl-6 mt-2">
                      <form th:action="@{/applications/{id}/documents(id=${doc.applicationId})}"
                            method="POST"
                            enctype="multipart/form-data"
                            class="flex flex-col gap-2">
                        <input type="hidden" name="type" th:value="${doc.type}"/>
                        <div class="flex items-center gap-2">
                          <input type="file"
                                 class="file-input file-input-bordered file-input-xs w-full max-w-xs"
                                 name="file"
                                 accept="application/pdf"
                                 required/>
                          <button class="btn btn-primary btn-xs">Re-upload</button>
                        </div>
                      </form>
                    </div>

                    <!-- Initial upload form -->
                    <div th:unless="${doc.submitted}" class="pl-6">
                      <div class="flex flex-col gap-2">
                        <!-- Download blank form button -->
                        <a th:href="@{/applications/{appId}/documents/{type}/blank(appId=${doc.applicationId},type=${doc.type})}"
                           class="btn btn-xs btn-outline"
                           target="_blank">
                          Download Blank Form
                        </a>

                        <!-- Upload form -->
                        <form th:action="@{/applications/{id}/documents(id=${doc.applicationId})}"
                              method="POST"
                              enctype="multipart/form-data"
                              class="flex flex-col gap-2">
                          <!-- Show error message if present -->
                          <div th:if="${error}" class="alert alert-error shadow-lg py-2 px-4">
                            <div class="flex items-center gap-2">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4"
                                   viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd"
                                      d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                                      clip-rule="evenodd"/>
                              </svg>
                              <span class="text-sm" th:text="${error}"></span>
                            </div>
                          </div>

                          <input type="hidden" name="type" th:value="${doc.type}"/>
                          <input type="file"
                                 class="file-input file-input-bordered file-input-xs w-full max-w-xs"
                                 name="file"
                                 accept="application/pdf"
                                 required/>
                          <div class="flex items-center justify-between">
                            <button class="btn btn-primary btn-xs">Upload</button>
                            <!-- Deadline information -->
                            <span class="text-xs"
                                  th:classappend="${doc.deadline.isBefore(T(java.time.LocalDate).now())} ? 'text-error' : 'text-warning'">
                                                            <span th:if="${doc.deadline.isAfter(T(java.time.LocalDate).now())}"
                                                                  th:text="'Due in: ' + ${T(java.time.temporal.ChronoUnit).DAYS.between(T(java.time.LocalDate).now(), doc.deadline)} + ' days'">
                                                            </span>
                                                            <span th:unless="${doc.deadline.isAfter(T(java.time.LocalDate).now())}"
                                                                  th:text="'Overdue by: ' + ${T(java.time.temporal.ChronoUnit).DAYS.between(doc.deadline, T(java.time.LocalDate).now())} + ' days'">
                                                            </span>
                                                        </span>
                          </div>

                          <!-- Note about PDF requirement -->
                          <p class="text-xs text-base-content/70">
                            Please download the blank form, fill it out, and upload it as a PDF
                          </p>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Message for non-approved/enrolled applications -->
                <div th:unless="${pair.app().status() == T(com.example.abroad.model.Application.Status).APPROVED ||
                                                         pair.app().status() == T(com.example.abroad.model.Application.Status).ENROLLED}"
                     class="text-base-content/50 italic text-sm">
                  Documents required after approval
                </div>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
<div th:replace="~{components :: footer}"></div>
</body>
</html>

<div xmlns:th="http://www.thymeleaf.org" th:fragment="sortableHeader(label, path, column, target)">
  <th th:class="${sort.name == column} ? 'bg-base-300 cursor-pointer' : 'cursor-pointer'"
      th:hx-get="@{${path}(sort=${column}, ascending=!${ascending})}"
      th:hx-target="${target}"
      hx-swap="outerHTML">
    <div class="flex items-center gap-2">
      <span th:if="${sort.name == column}" th:text="${ascending} ? '▲' : '▼'"></span>
      <div th:unless="${sort.name == column}" class="invisible">▼</div>
      <span th:text="${label}"></span>
    </div>
  </th>
</div>